// proto/iprl.proto
syntax = "proto3";

package iprl;

option go_package = "iprl-demo/internal/gen/proto";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// === Probing Agent ===
service ProbingAgentInterface {
  rpc Update(ProbingAgentStatus) returns (google.protobuf.Empty);
}

// === Probing Directive Generator ===
service ProbingDirectiveGeneratorInterface {
  rpc Update(ProbingDirectiveGeneratorStatus) returns (google.protobuf.Empty);
}

// === Probing Orchestrator === 
message JoinRequest {
  oneof spec {
    ProbingAgentSpec probing_agent_spec = 1;
    ProbingDirectiveGeneratorSpec probing_directive_generator_spec = 2;
  }
}

message JoinResponse {
  oneof status {
    ProbingAgentStatus probing_agent_status = 1;
    ProbingDirectiveGeneratorStatus probing_directive_generator_status = 2;
  }
}

message LeaveRequest {
  string uuid = 1;
}

service ProbingOrchestratorInterface {
  // Component joins the cluster and receives its assigned status
  rpc Join(JoinRequest) returns (JoinResponse);

  // Component leaves the cluster gracefully
  rpc Leave(LeaveRequest) returns (google.protobuf.Empty);

  // Any component who wants to stream probing directives to the orchstrator should use this.
  rpc PushProbingDirectives(stream ProbingDirective) returns (google.protobuf.Empty);

  // Any component who wants to stream probing directives to the orchstrator should use this.
  rpc PushForwardingInfoElements(stream ForwardingInfoElement) returns (stream ProbingDirective);

  // This is the actual streaming the generated forwarding info elements.
  rpc PullForwardingInfoElements(google.protobuf.Empty) returns (stream ForwardingInfoElement);
}

// === Common types === 
enum VantagePointProvider {
  VANTAGE_POINT_PROVIDER_UNKNOWN = 0;
  VANTAGE_POINT_PROVIDER_GCP = 1;
  VANTAGE_POINT_PROVIDER_AWS = 2;
  VANTAGE_POINT_PROVIDER_EDGENET = 3;
}

// === Domain types ===
message VantagePoint {
  string                name = 1;
  bytes                 public_address = 2;
  optional uint32       asn = 3;
  VantagePointProvider  provider = 4;
}

message ProbingAgentSpec {
  string            software_version = 2;
  string            interface_version = 3;
  string            interface_addr = 4;
  VantagePoint      vantage_point = 5;
  uint32            directive_buffer_length = 6;
  string            orchestrator_address = 9;
  uint32            num_retries = 10;
}

message ProbingAgentStatus {
  string                uuid = 1;
  uint32                probing_rate_cap = 2;
  map<string, string>   tags = 3;
}

message ProbingDirectiveGeneratorSpec {
  string                software_version = 2;
  string                interface_version = 3;
  string                interface_addr = 4;
  repeated Protocol     protocols = 5;
  uint32                min_ttl = 7;
  uint32                max_ttl = 8;
  string                orchestrator_address = 9;
  uint32                num_retries = 10;
  int64                 seed = 12;
}

message ProbingDirectiveGeneratorStatus {
  string                    uuid = 1;
  uint32                    probe_generation_rate_per_second_per_agent = 6;
  repeated ProbingAgentSpec agent_specs = 7;
  map<string, string>       tags = 9;
}

message ProbingOrchestratorSpec {
  string software_version = 2;
  string interface_version = 3;
  string interface_addr = 4;
  uint32 directive_buffer_length = 6;
  uint32 element_buffer_length = 7;
  uint32 default_global_probing_rate_cap = 8;
  uint32 num_retries = 10;
}

message ProbingOrchestratorStatus {
  uint32 global_probing_rate_cap = 2;
}

// === Probing Directive ===
enum Protocol {
  PROTOCOL_UNKNOWN = 0;
  PROTOCOL_ICMP = 1;
  PROTOCOL_TCP = 6;
  PROTOCOL_UDP = 17;
  PROTOCOL_DCCP = 33;
  PROTOCOL_ICMPV6 = 58;
}

enum IPVersion {
  IP_VERSION_4 = 0;
  IP_VERSION_6 = 1;
}

message HeaderParameters {
  optional uint32 source_port = 1;      // 16-bits
  optional uint32 destination_port = 2; // 16-bits
  optional uint32 type_of_service = 3;  // 8-bits
  optional bool   df_flag = 4;          // 1-bit
}

message ProbingDirective {
  string                    vantage_point_name = 1;
  bytes                     destination_address = 2;
  IPVersion                 ip_version = 3; 
  Protocol                  protocol = 4;
  optional HeaderParameters header_parameters = 5;
  uint32                    near_ttl = 6;
  uint32                    destination_port = 7;
}

// === Forwarding Info Element ===
enum ChangeType {
  WITHDRAWN = 0;
  ANNOUNCED = 1;
}

enum JustificationType {
  INFERRED = 0;
  OBSERVED = 1;
}

message MPLSLabel {
  uint32    label = 1;
  uint32    tc = 2;
  bool      s = 3;
  uint32    ttl = 4;
}

message MPLSInfo {
  repeated MPLSLabel labels = 1;
}

message RTTInfo {
  google.protobuf.Timestamp sent_at = 1;
  google.protobuf.Timestamp received_at = 2;
}

message MDAParameters {
  int32     flow_count = 1;
  double    confidence = 2;
  int32     max_retries = 3;
  string    algo_version = 4;
}

message ForwardingInfoElement {
  VantagePoint              vantage_point = 1;
  uint64                    flow_id = 2;
  uint32                    near_ttl = 3;
  bytes                     near_reply_address = 4;
  bytes                     far_reply_address = 5;
  bytes                     destination_addr = 6;
  bytes                     source_addr = 7;
  MPLSInfo                  mpls = 8;
  int32                     packet_size = 17;
  RTTInfo                   near_rtt = 9;
  RTTInfo                   far_rtt = 10;
  uint32                    packets_sent = 11;
  uint32                    packets_received = 12;
  MDAParameters             mda = 13; // extra
  ChangeType                change_type = 14;
  JustificationType         justification_type = 15;
  google.protobuf.Timestamp construction_timestamp = 16;
}

